# Ansible Configuration Management

Ansible is used to configure the operating system of all hosts:
- **Physical:** Raspberry Pi, Proxmox Hosts.
- **Virtual:** K3s Nodes (Ubuntu 24.04).

## üìÇ Directory Structure

```
ansible/
‚îú‚îÄ‚îÄ inventories/
‚îÇ   ‚îú‚îÄ‚îÄ baremetal.yml          # Physical hosts (Manual IP entry)
‚îÇ   ‚îú‚îÄ‚îÄ k3s-nodes.yml          # VMs (Generated by Terraform)
‚îÇ   ‚îú‚îÄ‚îÄ all-vms.yml            # Group definitions
‚îÇ   ‚îî‚îÄ‚îÄ group_vars/            # Variables per group (e.g., all.yml, proxmox.yml)
‚îú‚îÄ‚îÄ playbooks/
‚îÇ   ‚îú‚îÄ‚îÄ rpi.yml                # Configures RPi
‚îÇ   ‚îú‚îÄ‚îÄ proxmox.yml            # Configures Proxmox
‚îÇ   ‚îî‚îÄ‚îÄ ubuntu_vms.yml         # Configures VMs (K3s prep)
‚îú‚îÄ‚îÄ roles/                     # Reusable logic
‚îî‚îÄ‚îÄ ansible.cfg                # Defaults
```

## üöÄ Workflows

### 1. Initial Setup
When setting up the lab for the first time:

```bash
# Install deps
pip install ansible ansible-lint

# Configure RPi
ansible-playbook -i inventories/baremetal.yml playbooks/rpi.yml

# Configure Proxmox
ansible-playbook -i inventories/baremetal.yml playbooks/proxmox.yml

# Configure VMs (After Terraform runs)
ansible-playbook -i inventories/all-vms.yml -i inventories/k3s-nodes.yml playbooks/ubuntu_vms.yml
```

### 2. Maintenance

**Update System Packages:**
```bash
ansible all -i inventories/baremetal.yml -i inventories/k3s-nodes.yml -m apt -a "update_cache=yes upgrade=dist" --become
```

**Reboot All Nodes:**
```bash
ansible k3s_nodes -i inventories/k3s-nodes.yml -m reboot --become
```

**Check Uptime:**
```bash
ansible all -i inventories/baremetal.yml -i inventories/k3s-nodes.yml -m command -a "uptime"
```

## üõ†Ô∏è Roles Explained

### `common`
Applied to ALL hosts.
- Sets timezone (Europe/Berlin).
- Configures NTP.
- Adds SSH public keys.
- Installs base packages (curl, git, htop, etc.).

### `vms`
Applied to Virtual Machines only.
- **Disk Expansion:** Automatically resizes the root filesystem if the underlying virtual disk grows.
- **QEMU Agent:** Ensures the agent is running for Proxmox integration.

### `proxmox`
Applied to Proxmox hosts.
- **GRUB kernel params:** Safely merges baseline and host-specific kernel params into `/etc/default/grub` (`GRUB_CMDLINE_LINUX_DEFAULT`) and runs `update-grub` only on change. Protected boot-critical params are blocked (`root=`, `init=`, `systemd.unit=`, `resume=`, `cryptdevice=`, `rd.`, `BOOT_IMAGE=`).

Example:
```yaml
# Baseline (inventories/group_vars/proxmox.yml)
proxmox_kernel_params_base_add:
  - "intel_iommu=on"
  - "pcie_aspm=force"
  - "nmi_watchdog=0"
proxmox_kernel_params_base_remove: []

# Host (inventories/host_vars/pve1.yml)
proxmox_kernel_params_add:
  - "intel_idle.max_cstate=10"
  - "processor.max_cstate=10"
proxmox_kernel_params_remove:
  - "i915.enable_gvt=1"
```

- **CoreFreq (optional):** Installs CoreFreq via DKMS, loads `corefreqk`, and enables `corefreqd` when `proxmox_corefreq_enabled: true`. Variables: `proxmox_corefreq_version`, `proxmox_corefreq_git_repo`, `proxmox_corefreq_git_ref`, `proxmox_corefreq_modprobe_options`. Requires `community.general` for `modprobe` (`ansible-galaxy collection install community.general`). Disable by setting `proxmox_corefreq_enabled: false` (optional cleanup: remove `/etc/modules-load.d/corefreqk.conf` and `/etc/modprobe.d/corefreqk.conf`).

### `k3s`
Applied to K3s Nodes.
- **Kernel Tuning:** Enables IP forwarding, bridge-nf-call-iptables.
- **Dependencies:** Installs `open-iscsi`, `nfs-common`, `cryptsetup` (required for Longhorn).

## ‚ö†Ô∏è Important Notes

1.  **SSH Keys:** The public keys in `group_vars/all.yml` are overwritten on every run. If you add a key manually to `~/.ssh/authorized_keys`, Ansible will remove it. Add it to the YAML instead.
2.  **Generated Inventory:** `inventories/k3s-nodes.yml` is managed by Terraform. Do not edit it manually; your changes will be lost next time you run `terraform apply`.
3.  **Proxmox:** We are careful with the Proxmox hosts. We do NOT enable unattended upgrades on them to prevent unexpected reboots of the hypervisor.

## Troubleshooting

- **"Permission denied (publickey)":** Check if your local SSH key is loaded (`ssh-add -l`) and matches the one in `group_vars/all.yml`.
- **"Host key verification failed":** The VM was probably recreated with a new fingerprint. Run `ssh-keygen -R <IP>` to clear it.

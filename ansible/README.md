# Ansible Configuration Management

Ansible is used to configure the operating system of all hosts:
- **Physical:** Raspberry Pi, Proxmox Hosts.
- **Virtual:** K3s Nodes (Ubuntu 24.04).

## ğŸ“‚ Directory Structure

```
ansible/
â”œâ”€â”€ inventories/
â”‚   â”œâ”€â”€ baremetal.yml          # Physical hosts (Manual IP entry)
â”‚   â”œâ”€â”€ k3s-nodes.yml          # VMs (Generated by Terraform)
â”‚   â”œâ”€â”€ all-vms.yml            # Group definitions
â”‚   â””â”€â”€ group_vars/            # Variables per group (e.g., all.yml, proxmox.yml)
â”œâ”€â”€ playbooks/
â”‚   â”œâ”€â”€ rpi.yml                # Configures RPi
â”‚   â”œâ”€â”€ proxmox.yml            # Configures Proxmox
â”‚   â””â”€â”€ ubuntu_vms.yml         # Configures VMs (K3s prep)
â”œâ”€â”€ roles/                     # Reusable logic
â””â”€â”€ ansible.cfg                # Defaults
```

## ğŸš€ Workflows

### 1. Initial Setup
When setting up the lab for the first time:

```bash
# Install deps
pip install ansible ansible-lint

# Configure RPi
ansible-playbook -i inventories/baremetal.yml playbooks/rpi.yml

# Configure Proxmox
ansible-playbook -i inventories/baremetal.yml playbooks/proxmox.yml

# Configure VMs (After Terraform runs)
ansible-playbook -i inventories/all-vms.yml -i inventories/k3s-nodes.yml playbooks/ubuntu_vms.yml
```

### 2. Maintenance

**Update System Packages:**
```bash
ansible all -i inventories/baremetal.yml -i inventories/k3s-nodes.yml -m apt -a "update_cache=yes upgrade=dist" --become
```

**Reboot All Nodes:**
```bash
ansible k3s_nodes -i inventories/k3s-nodes.yml -m reboot --become
```

**Check Uptime:**
```bash
ansible all -i inventories/baremetal.yml -i inventories/k3s-nodes.yml -m command -a "uptime"
```

## ğŸ› ï¸ Roles Explained

### `common`
Applied to ALL hosts.
- Sets timezone (Europe/Berlin).
- Configures NTP.
- Adds SSH public keys.
- Installs base packages (curl, git, htop, etc.).

### `vms`
Applied to Virtual Machines only.
- **Disk Expansion:** Automatically resizes the root filesystem if the underlying virtual disk grows.
- **QEMU Agent:** Ensures the agent is running for Proxmox integration.

### `proxmox`
Applied to Proxmox hosts.
- **GRUB kernel params:** Safely merges baseline and host-specific kernel params into `/etc/default/grub` (`GRUB_CMDLINE_LINUX_DEFAULT`) and runs `update-grub` only on change. Protected boot-critical params are blocked (`root=`, `init=`, `systemd.unit=`, `resume=`, `cryptdevice=`, `rd.`, `BOOT_IMAGE=`).

Example:
```yaml
# Baseline (inventories/group_vars/proxmox.yml)
proxmox_kernel_params_base_add:
  - "intel_iommu=on"
  - "pcie_aspm=force"
  - "nmi_watchdog=0"
proxmox_kernel_params_base_remove: []

# Host (inventories/host_vars/pve1.yml)
proxmox_kernel_params_add:
  - "intel_idle.max_cstate=10"
  - "processor.max_cstate=10"
proxmox_kernel_params_remove:
  - "i915.enable_gvt=1"
```

### `k3s`
Applied to K3s Nodes.
- **Kernel Tuning:** Enables IP forwarding, bridge-nf-call-iptables.
- **Dependencies:** Installs `open-iscsi`, `nfs-common`, `cryptsetup` (required for Longhorn).

## âš ï¸ Important Notes

1.  **SSH Keys:** The public keys in `group_vars/all.yml` are overwritten on every run. If you add a key manually to `~/.ssh/authorized_keys`, Ansible will remove it. Add it to the YAML instead.
2.  **Generated Inventory:** `inventories/k3s-nodes.yml` is managed by Terraform. Do not edit it manually; your changes will be lost next time you run `terraform apply`.
3.  **Proxmox:** We are careful with the Proxmox hosts. We do NOT enable unattended upgrades on them to prevent unexpected reboots of the hypervisor.

## Troubleshooting

- **"Permission denied (publickey)":** Check if your local SSH key is loaded (`ssh-add -l`) and matches the one in `group_vars/all.yml`.
- **"Host key verification failed":** The VM was probably recreated with a new fingerprint. Run `ssh-keygen -R <IP>` to clear it.

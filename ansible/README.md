### Ansible â€“ Home Lab Provisioning

Scaffolding to manage Home Lab infrastructure, including Raspberry Pi hosts (3/4/5/CM) and Proxmox VE nodes.

Structure:
- `inventories/hosts.yml` defines the inventory with two main groups: `rpi` and `proxmox`.
- `inventories/k3s-nodes.yml` (generated by Terraform) contains the K3s node VMs.
- `inventories/group_vars/` contains group-specific overrides:
    - `rpi.yml`: Defaults for Raspberry Pi (security hardening, common packages).
    - `proxmox.yml`: Overrides for Proxmox (disables auto-upgrades, allows root key login).
    - `all.yml`: Shared settings like SSH keys, timezone, and NTP servers.
- `playbooks/` contains site-specific playbooks:
    - `rpi.yml`: Targets `rpi` group.
    - `proxmox.yml`: Targets `proxmox` group.
- `roles/common` contains shared tasks for system setup (users, SSH keys, timezone, NTP) with feature flags to toggle behaviors (e.g., upgrades, hushlogin).

Usage:
1. Update `inventories/hosts.yml` with your hosts and IPs.
2. Update `inventories/group_vars/all.yml` with your public SSH keys (`common_authorized_keys`).
3. Add host vars (e.g., `inventories/host_vars/main-rpi4.yml`) for unique per-host settings (extra packages, netplan config).
4. Run commands from the `ansible/` directory:
   - **Raspberry Pi:**
     `ansible-playbook -i inventories/hosts.yml playbooks/rpi.yml`
   - **Proxmox:**
     `ansible-playbook -i inventories/hosts.yml playbooks/proxmox.yml`
5. Dry run mode: Append `--check` to any command.

### Role Behavior

The `common` role behaves differently based on the target group:

| Feature | Raspberry Pi | Proxmox |
| :--- | :--- | :--- |
| **User** | `ansible_user` (default: `pi`) | `root` |
| **SSH Root Login** | Disabled (`no`) | Keys Only (`prohibit-password`) |
| **Auto-Upgrades** | **Enabled** (unattended-upgrades) | **Disabled** (Manual control required) |
| **Run `apt dist-upgrade`** | Yes (on playbook run) | No (Skipped) |
| **Hushlogin** | Created | Skipped |

Notes:
- `common_timezone` sets the system timezone via `timedatectl`.
- `common_ntp_servers` installs/enables systemd-timesyncd.
- `common_netplan_config` (optional) renders `/etc/netplan/01-main.yaml` when provided and triggers `netplan apply`.
- Hostname is set to match the inventory name (`inventory_hostname`) during provisioning.

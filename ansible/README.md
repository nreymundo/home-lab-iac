# Ansible Configuration Management

Ansible is used to configure the operating system of all hosts:
- **Physical:** Raspberry Pi, Proxmox Hosts, Fedora Baremetal.
- **Virtual:** K3s Nodes (Ubuntu 24.04).

## Directory Structure

```
ansible/
├── inventories/
│   ├── baremetal.yml          # Physical hosts (Manual IP entry)
│   ├── k3s-nodes.yml          # VMs (Generated by Terraform)
│   ├── all-vms.yml            # Group definitions
│   └── group_vars/            # Variables per group (e.g., all.yml, proxmox.yml, fedora.yml)
├── playbooks/
│   ├── rpi.yml                # Configures RPi
│   ├── proxmox.yml            # Configures Proxmox
│   ├── fedora.yml             # Configures Fedora baremetal
│   └── ubuntu_vms.yml         # Configures VMs (K3s prep)
├── roles/                     # Reusable logic
└── ansible.cfg                # Defaults
```

## Workflows

### 1. Initial Setup
When setting up the lab for the first time:

```bash
# Install deps
pip install ansible ansible-lint

# Configure RPi
ansible-playbook -i inventories/baremetal.yml playbooks/rpi.yml

# Configure Proxmox
ansible-playbook -i inventories/baremetal.yml playbooks/proxmox.yml

# Configure Fedora baremetal
ansible-playbook -i inventories/baremetal.yml playbooks/fedora.yml

# Configure VMs (After Terraform runs)
ansible-playbook -i inventories/all-vms.yml -i inventories/k3s-nodes.yml playbooks/ubuntu_vms.yml
```

### 2. Fedora Host Setup

Before running the Fedora playbook:

1. Install Fedora on the target host
2. Find the network interface name: `ip link show`
3. Update `inventories/host_vars/framework.yml` with the actual interface name (replace `<FILL_IN>`)
4. Run the playbook:

```bash
ansible-playbook -i inventories/baremetal.yml playbooks/fedora.yml
```

The playbook configures:
- Static IP on the main interface (192.168.1.x)
- VLAN 10 for K3s traffic (192.168.10.x)
- Automatic updates via dnf-automatic with reboot at 08:00
- NTP via chrony

### 3. Maintenance

**Update System Packages (Debian/Ubuntu):**
```bash
ansible all -i inventories/baremetal.yml -i inventories/k3s-nodes.yml -m apt -a "update_cache=yes upgrade=dist" --become
```

**Update System Packages (Fedora):**
```bash
ansible fedora -i inventories/baremetal.yml -m dnf -a "name=* state=latest" --become
```

**Reboot All Nodes:**
```bash
ansible k3s_nodes -i inventories/k3s-nodes.yml -m reboot --become
```

**Check Uptime:**
```bash
ansible all -i inventories/baremetal.yml -i inventories/k3s-nodes.yml -m command -a "uptime"
```

## Roles Explained

### `common`
Applied to ALL hosts. Automatically detects OS family (Debian vs RedHat) and applies appropriate configuration.

**Shared tasks (all OS):**
- Sets timezone (Europe/Berlin)
- Configures hostname
- Hardens SSH daemon
- Adds SSH public keys
- Installs base packages
- Enables scheduled fstrim (configurable via common_enable_fstrim)

**Debian/Ubuntu specific:**
- Package management via apt
- NTP via systemd-timesyncd
- Network config via netplan
- Automatic updates via unattended-upgrades

**Fedora/RedHat specific:**
- Package management via dnf
- NTP via chrony
- Network config via NetworkManager keyfiles
- Automatic updates via dnf-automatic
- Kernel boot params via grubby: Safely merges baseline and host-specific kernel params using `grubby --update-kernel=ALL`. Protected boot-critical params are blocked (`root=`, `init=`, `systemd.unit=`, `resume=`, `cryptdevice=`, `rd.`, `BOOT_IMAGE=`).

Example:
```yaml
# Baseline (inventories/group_vars/fedora.yml)
common_kernel_params_base_add:
  - "transparent_hugepage=never"
common_kernel_params_base_remove: []

# Host (inventories/host_vars/framework.yml)
common_kernel_params_add:
  - "max_loop=64"
common_kernel_params_remove:
  - "quiet"
```

### `vms`
Applied to Virtual Machines only.
- **Disk Expansion:** Automatically resizes the root filesystem if the underlying virtual disk grows.
- **QEMU Agent:** Ensures the agent is running for Proxmox integration.

### `proxmox`
Applied to Proxmox hosts.
- **GRUB kernel params:** Safely merges baseline and host-specific kernel params into `/etc/default/grub` (`GRUB_CMDLINE_LINUX_DEFAULT`) and runs `update-grub` only on change. Protected boot-critical params are blocked (`root=`, `init=`, `systemd.unit=`, `resume=`, `cryptdevice=`, `rd.`, `BOOT_IMAGE=`).

Example:
```yaml
# Baseline (inventories/group_vars/proxmox.yml)
proxmox_kernel_params_base_add:
  - "intel_iommu=on"
  - "pcie_aspm=force"
  - "nmi_watchdog=0"
proxmox_kernel_params_base_remove: []

# Host (inventories/host_vars/pve1.yml)
proxmox_kernel_params_add:
  - "intel_idle.max_cstate=10"
  - "processor.max_cstate=10"
proxmox_kernel_params_remove:
  - "i915.enable_gvt=1"
```

- **CoreFreq (optional):** Installs CoreFreq via DKMS, loads `corefreqk`, and enables `corefreqd` when `proxmox_corefreq_enabled: true`. Variables: `proxmox_corefreq_version`, `proxmox_corefreq_git_repo`, `proxmox_corefreq_git_ref`, `proxmox_corefreq_modprobe_options`. Requires `community.general` for `modprobe` (`ansible-galaxy collection install community.general`). Disable by setting `proxmox_corefreq_enabled: false` (optional cleanup: disable `corefreqd`, remove the DKMS module, delete `/usr/src/corefreqk-*`, and remove `/etc/modules-load.d/corefreqk.conf` + `/etc/modprobe.d/corefreqk.conf`).

### `k3s`
Applied to K3s Nodes.
- **Kernel Tuning:** Enables IP forwarding, bridge-nf-call-iptables.
- **Dependencies:** Installs `open-iscsi`, `nfs-common`, `cryptsetup` (required for Longhorn).

## Network Configuration

### Debian/Ubuntu (netplan)
Configure via `common_netplan_config` in host_vars:

```yaml
common_netplan_config:
  network:
    version: 2
    renderer: networkd
    ethernets:
      eth0:
        addresses:
          - 192.168.1.7/24
        gateway4: 192.168.1.1
        nameservers:
          addresses:
            - 192.168.1.1
    vlans:
      vlan10:
        id: 10
        link: eth0
        addresses:
          - 192.168.10.7/24
```

### Fedora/RedHat (NetworkManager)
Configure via `common_nm_connections` in host_vars:

```yaml
common_nm_connections:
  - name: main
    type: ethernet
    interface: enp1s0
    ipv4:
      addresses:
        - 192.168.1.6/24
      gateway: 192.168.1.1
      dns:
        - 192.168.1.1

  - name: vlan10
    type: vlan
    vlan_id: 10
    parent: enp1s0
    ipv4:
      addresses:
        - 192.168.10.6/24
```

## Important Notes

1.  **SSH Keys:** The public keys in `group_vars/all.yml` are overwritten on every run. If you add a key manually to `~/.ssh/authorized_keys`, Ansible will remove it. Add it to the YAML instead.
2.  **Generated Inventory:** `inventories/k3s-nodes.yml` is managed by Terraform. Do not edit it manually; your changes will be lost next time you run `terraform apply`.
3.  **Proxmox:** We are careful with the Proxmox hosts. We do NOT enable unattended upgrades on them to prevent unexpected reboots of the hypervisor.
4.  **Fedora Interface Names:** Fedora uses predictable interface names (e.g., `enp1s0`). Check with `ip link show` and update host_vars before running the playbook.
5.  **Trim:** `fstrim.timer` is enabled by default on guests; disable with `common_enable_fstrim: false` (e.g., `inventories/group_vars/proxmox.yml`). Discard must be enabled to reclaim space.

## Troubleshooting

- **"Permission denied (publickey)":** Check if your local SSH key is loaded (`ssh-add -l`) and matches the one in `group_vars/all.yml`.
- **"Host key verification failed":** The VM was probably recreated with a new fingerprint. Run `ssh-keygen -R <IP>` to clear it.
- **NetworkManager changes not applied:** Run `nmcli connection reload` and `nmcli connection up <name>` manually, or reboot the host.

---
- name: Install K3s dependencies
  ansible.builtin.apt:
    name:
      - curl
      - open-iscsi
      - nfs-common
    state: present
    update_cache: true

- name: Enable cgroups for Raspberry Pi
  when: "'rpi' in group_names"
  block:
    - name: Read cmdline.txt
      ansible.builtin.slurp:
        src: /boot/firmware/cmdline.txt
      register: rpi_cmdline_b64
      ignore_errors: true

    - name: Fallback to /boot/cmdline.txt if firmware path fails
      ansible.builtin.slurp:
        src: /boot/cmdline.txt
      register: rpi_cmdline_legacy_b64
      when: rpi_cmdline_b64.failed

    - name: Set cmdline path fact
      ansible.builtin.set_fact:
        rpi_cmdline_path: >-
          {{
            '/boot/firmware/cmdline.txt' if not rpi_cmdline_b64.failed else '/boot/cmdline.txt'
          }}
        rpi_cmdline_content: >-
          {{
            (rpi_cmdline_b64.content if not rpi_cmdline_b64.failed else rpi_cmdline_legacy_b64.content)
            | b64decode
            | trim
          }}

    - name: Add cgroup settings to cmdline.txt
      ansible.builtin.lineinfile:
        path: "{{ rpi_cmdline_path }}"
        backrefs: true
        regexp: '^(?!.*(?:cgroup_enable=cpuset|cgroup_enable=memory|cgroup_memory=1)).*$'
        line: '\0 cgroup_enable=cpuset cgroup_enable=memory cgroup_memory=1'
      register: rpi_cgroup_update
      notify: Reboot RPi for cgroups

- name: Validate K3s seed node configuration
  ansible.builtin.assert:
    that:
      - seed_nodes | length <= 1
    fail_msg: >-
          Multiple K3s seed nodes found ({{ seed_nodes | join(', ') }}).
          Please ensure exactly one host has k3s_is_seed: true.
  run_once: true
  vars:
    seed_nodes: >-
          {{
            hostvars
            | dict2items
            | selectattr('value.k3s_is_seed', 'defined')
            | selectattr('value.k3s_is_seed', 'equalto', true)
            | map(attribute='key')
            | list
          }}

- name: Identify K3s seed node
  ansible.builtin.set_fact:
    k3s_seed_host: "{{ (seed_nodes | first) if (seed_nodes | length > 0) else (groups['k3s_nodes'][0]) }}"
  run_once: true
  vars:
    seed_nodes: >-
          {{
            hostvars
            | dict2items
            | selectattr('value.k3s_is_seed', 'defined')
            | selectattr('value.k3s_is_seed', 'equalto', true)
            | map(attribute='key')
            | list
          }}

- name: Ensure K3s interface is set
  ansible.builtin.assert:
    that:
      - (k3s_iface | default('')) | length > 0
    fail_msg: "k3s_iface is empty; set it to the interface carrying k3s_node_ip"

- name: Create K3s installation directory
  ansible.builtin.file:
    path: /usr/local/bin
    state: directory
    mode: "0755"
  become: true

- name: Download K3s binary (amd64)
  ansible.builtin.get_url:
    url: https://github.com/k3s-io/k3s/releases/download/{{ k3s_version }}/k3s
    dest: /usr/local/bin/k3s
    mode: "0755"
    checksum: "sha256:{{ k3s_amd64_checksum }}"
    timeout: 120
  become: true
  when: ansible_architecture == "x86_64"

- name: Download K3s binary (arm64)
  ansible.builtin.get_url:
    url: https://github.com/k3s-io/k3s/releases/download/{{ k3s_version }}/k3s-arm64
    dest: /usr/local/bin/k3s
    mode: "0755"
    checksum: "sha256:{{ k3s_arm64_checksum }}"
    timeout: 120
  become: true
  when: ansible_architecture == "aarch64"

- name: Create K3s symlink
  ansible.builtin.file:
    src: /usr/local/bin/k3s
    dest: /usr/local/bin/kubectl
    state: link
  become: true

- name: Install K3s on Seed Node
  when: inventory_hostname == k3s_seed_host
  block:
    - name: Create K3s systemd service
      ansible.builtin.template:
        src: k3s.service.j2
        dest: /etc/systemd/system/k3s.service
        mode: "0644"
      become: true
      vars:
        k3s_exec_args: >
          server
          --cluster-init
          --node-ip {{ k3s_node_ip }}
          --flannel-iface {{ k3s_iface }}
          --write-kubeconfig-mode 644
          --disable traefik
          --disable metrics-server

    - name: Enable and start K3s service (Seed)
      ansible.builtin.systemd:
        name: k3s
        state: started
        enabled: true
        daemon_reload: true
      become: true

    - name: Wait for K3s to be ready
      ansible.builtin.command: k3s kubectl get nodes
      register: k3s_ready
      until: k3s_ready.rc == 0
      retries: 30
      delay: 5
      changed_when: false

    - name: Get K3s token
      ansible.builtin.slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: k3s_token_b64
      when: not ansible_check_mode

    - name: Register token fact
      ansible.builtin.set_fact:
        k3s_cluster_token: "{{ k3s_token_b64.content | b64decode | trim }}"
      when: not ansible_check_mode and k3s_token_b64 is success

    - name: Fetch Kubeconfig to repository root
      ansible.builtin.fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: k3s.yaml
        flat: true
      when: not ansible_check_mode

    - name: Update Kubeconfig server address
      ansible.builtin.replace:
        path: k3s.yaml
        regexp: '127.0.0.1'
        replace: "{{ k3s_node_ip | default(ansible_host) }}"
      delegate_to: localhost
      become: false
      when: not ansible_check_mode

- name: Validate K3s token is available on secondary nodes
  ansible.builtin.assert:
    that:
      - hostvars[k3s_seed_host]['k3s_cluster_token'] is defined
      - hostvars[k3s_seed_host]['k3s_cluster_token'] | length > 0
    fail_msg: >-
          K3s cluster token is not available from seed node {{ k3s_seed_host }}.
          Ensure seed node installation succeeded.
  when: inventory_hostname != k3s_seed_host

- name: Distribute K3s token to other nodes
  ansible.builtin.set_fact:
    k3s_cluster_token: "{{ hostvars[k3s_seed_host]['k3s_cluster_token'] }}"
    k3s_seed_ip: >-
      {{
        hostvars[k3s_seed_host]['k3s_node_ip']
        | default(hostvars[k3s_seed_host]['ansible_host'])
        | default('127.0.0.1')
      }}
  when: inventory_hostname != k3s_seed_host

- name: Install K3s on Secondary Nodes
  when: inventory_hostname != k3s_seed_host
  block:
    - name: Wait for Seed Node API
      ansible.builtin.wait_for:
        host: "{{ k3s_seed_ip }}"
        port: 6443
        timeout: 600

    - name: Create K3s systemd service
      ansible.builtin.template:
        src: k3s.service.j2
        dest: /etc/systemd/system/k3s.service
        mode: "0644"
      become: true
      vars:
        k3s_exec_args: >
          server
          --server https://{{ k3s_seed_ip }}:6443
          --token {{ k3s_cluster_token }}
          --node-ip {{ k3s_node_ip }}
          --flannel-iface {{ k3s_iface }}
          --disable traefik
          --disable metrics-server

    - name: Enable and start K3s service (Secondary)
      ansible.builtin.systemd:
        name: k3s
        state: started
        enabled: true
        daemon_reload: true
      become: true

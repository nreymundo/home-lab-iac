---

- name: Manage Proxmox kernel parameters
  ansible.builtin.include_tasks: bootloader_kernel_params.yml

- name: Configure swap
  ansible.builtin.include_tasks: swap.yml


- name: Manage Proxmox module blacklist
  ansible.builtin.template:
    src: modprobe_blacklist.conf.j2
    dest: /etc/modprobe.d/pve-blacklist.conf
    owner: root
    group: root
    mode: "0644"
  when: proxmox_modprobe_blacklist | default([]) | length > 0
  notify: Update initramfs

- name: Remove Proxmox module blacklist file when empty
  ansible.builtin.file:
    path: /etc/modprobe.d/pve-blacklist.conf
    state: absent
  when: proxmox_modprobe_blacklist | default([]) | length == 0
  notify: Update initramfs

- name: Manage Proxmox module options
  ansible.builtin.template:
    src: modprobe_options.conf.j2
    dest: /etc/modprobe.d/pve-options.conf
    owner: root
    group: root
    mode: "0644"
  when: proxmox_modprobe_options | default([]) | length > 0
  notify: Update initramfs

- name: Remove Proxmox module options file when empty
  ansible.builtin.file:
    path: /etc/modprobe.d/pve-options.conf
    state: absent
  when: proxmox_modprobe_options | default([]) | length == 0
  notify: Update initramfs

- name: Include Proxmox ZFS thin provisioning audit
  ansible.builtin.include_tasks: zfs_thin_audit.yml
  when: proxmox_zfs_thin_enforce | default(false) | bool or proxmox_zfs_thin_audit | default(true) | bool

- name: Include Proxmox ZFS thin provisioning fix
  ansible.builtin.include_tasks: zfs_thin_fix.yml
  when: proxmox_zfs_thin_enforce | default(false) | bool

- name: Configure ZFS ARC cache limits
  ansible.builtin.include_tasks: zfs_arc.yml

- name: CoreFreq (DKMS)
  ansible.builtin.include_tasks: corefreq.yml

- name: Set root .profile
  ansible.builtin.template:
    src: profile.j2
    dest: /root/.profile
    owner: root
    group: root
    mode: "0644"

- name: Set root .bashrc
  ansible.builtin.template:
    src: bashrc.j2
    dest: /root/.bashrc
    owner: root
    group: root
    mode: "0644"

- name: Ensure root .hushlogin exists
  ansible.builtin.file:
    path: /root/.hushlogin
    state: touch
    owner: root
    group: root
    mode: "0644"
    access_time: preserve
    modification_time: preserve

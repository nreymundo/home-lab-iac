---
- name: Verify required ZFS CLI tools exist
  ansible.builtin.command: "{{ item }}"
  args:
    executable: /bin/bash
  loop:
    - zfs
    - zpool
  register: proxmox_zfs_cli_check
  changed_when: false
  failed_when: "'command not found' in proxmox_zfs_cli_check.stderr"

- name: Verify all configured pools exist
  ansible.builtin.command: zpool list -H -o name "{{ item }}"
  args:
    executable: /bin/bash
  loop: "{{ proxmox_zfs_thin_pools }}"
  register: proxmox_zfs_pool_exists
  changed_when: false
  failed_when: "'No such pool' in proxmox_zfs_pool_exists.stderr"

- name: Show ZFS version for troubleshooting
  ansible.builtin.command: zfs version
  register: proxmox_zfs_version
  changed_when: false

- name: Show ZFS version output
  ansible.builtin.debug:
    var: proxmox_zfs_version.stdout_lines

- name: Collect pool health for all managed pools
  ansible.builtin.command: zpool list -H -o name,health "{{ item }}"
  args:
    executable: /bin/bash
  loop: "{{ proxmox_zfs_thin_pools }}"
  register: proxmox_zfs_pool_health
  changed_when: false

- name: Collect pool capacity for all managed pools (informational)
  ansible.builtin.command: zpool list -H -o name,cap "{{ item }}"
  args:
    executable: /bin/bash
  loop: "{{ proxmox_zfs_thin_pools }}"
  register: proxmox_zfs_pool_capacity
  changed_when: false

- name: Report pool status summary
  ansible.builtin.debug:
    msg: |
      Pool summary:
      {% for pool, health_res, cap_res in
         proxmox_zfs_thin_pools | zip(proxmox_zfs_pool_health.results, proxmox_zfs_pool_capacity.results) %}
      - {{ pool }}:
          Health={{ (health_res.stdout.split('\t')[-1]) | default('Unknown') }},
          Capacity={{ (cap_res.stdout.split('\t')[-1]) | default('Unknown') }}
      {% endfor %}

- name: Discover datasets/zvols with refreservation != none (excluding snapshots)
  ansible.builtin.shell: |
    set -eo pipefail
    pool="{{ item }}"
    zfs get -r -H -o name,value refreservation "${pool}" | \
    awk '$2 != "none" && $2 != "-" {print $0}'
  args:
    executable: /bin/bash
  loop: "{{ proxmox_zfs_thin_pools }}"
  register: proxmox_zfs_refreservation_findings
  changed_when: false

- name: Build consolidated findings list
  ansible.builtin.set_fact:
    proxmox_zfs_thin_datasets_to_fix: "{{ findings }}"
  vars:
    findings: >-
      {%- set results = [] -%}
      {%- for res in proxmox_zfs_refreservation_findings.results -%}
        {%- for line in res.stdout_lines -%}
          {%- set parts = line.split('\t') -%}
          {%- set _ = results.append({'name': parts[0], 'value': parts[1]}) -%}
        {%- endfor -%}
      {%- endfor -%}
      {{ results }}

- name: Audit report (non-thin datasets)
  ansible.builtin.debug:
    msg: |
      ZFS thin-provisioning audit:
      {% if (proxmox_zfs_thin_datasets_to_fix | default([]) | length) == 0 %}
      - No datasets with refreservation set (thin provisioning already in effect).
      {% else %}
      - The following datasets/zvols have refreservation != none (NOT thin):
      {% for item in proxmox_zfs_thin_datasets_to_fix %}
        * {{ item.name }} (refreservation={{ item.value }})
      {% endfor %}
      {% endif %}
  changed_when: false

# Ansible - AI Assistant Instructions

This document provides instructions for AI coding assistants (Claude, Gemini, etc.) working with the Ansible component.

## Directory Structure

```
ansible/
├── ansible.cfg           # Ansible configuration (inventory path, roles path, SSH settings)
├── inventories/          # Host and group definitions
│   ├── *.yml             # Inventory files (k3s-cluster.yml, baremetal.yml, etc.)
│   ├── group_vars/       # Variables applied to host groups
│   └── host_vars/        # Variables for specific hosts
├── playbooks/            # Playbook entry points
│   ├── k3s_cluster.yml   # Main K3s cluster provisioning
│   ├── proxmox.yml       # Proxmox host configuration
│   └── *.yml             # Other playbooks
└── roles/                # Reusable role modules
    ├── common/           # Base system configuration (packages, SSH, users)
    ├── k3s/              # K3s cluster installation and configuration
    ├── proxmox/          # Proxmox-specific configurations
    └── vms/              # VM-specific roles (secondary_disk, etc.)
```

## Key Files

| File | Purpose |
|------|---------|
| `ansible.cfg` | Default config - sets inventory path to `./inventories`, roles path, SSH pipelining |
| `inventories/k3s-nodes.yml` | **Auto-generated by Terraform** - K3s node definitions |
| `inventories/k3s-cluster.yml` | Aggregates k3s_nodes + baremetal hosts into `k3s_cluster` group |
| `inventories/group_vars/all.yml` | Global variables for all hosts |
| `playbooks/k3s_cluster.yml` | Main playbook for K3s provisioning |

## Role Structure

Each role follows standard Ansible structure:

```
roles/<role_name>/
├── defaults/main.yml    # Default variable values (lowest precedence)
├── tasks/main.yml       # Main task file (can include other task files)
├── handlers/main.yml    # Handlers triggered by notify
├── templates/*.j2       # Jinja2 templates
└── files/               # Static files to copy
```

## How to Add a New Role

1. Create the role directory structure:
   ```bash
   mkdir -p ansible/roles/<role_name>/{defaults,tasks,handlers,templates}
   ```

2. Create `defaults/main.yml` with default variables:
   ```yaml
   ---
   my_role_variable: "default_value"
   ```

3. Create `tasks/main.yml` with tasks:
   ```yaml
   ---
   - name: Install packages
     ansible.builtin.apt:
       name: "{{ my_role_packages }}"
       state: present
     when: ansible_os_family == 'Debian'
   ```

4. Add the role to the appropriate playbook.

## How to Add a New Host

1. Add the host to the appropriate inventory file in `inventories/`
2. Create host-specific variables in `inventories/host_vars/<hostname>.yml`
3. Ensure the host belongs to the correct groups

> **Note**: K3s nodes are auto-generated by Terraform. Modify `terraform/k3s_nodes/terraform.tfvars` instead.

## How to Run Playbooks

**Always run from the `ansible/` directory** (or specify `-i` path):

```bash
cd ansible

# Dry-run (check mode) - shows what would change
ansible-playbook playbooks/k3s_cluster.yml --check

# Full run with verbose output
ansible-playbook playbooks/k3s_cluster.yml -v

# Target specific hosts
ansible-playbook playbooks/k3s_cluster.yml --limit "k3s-node-01"

# Target specific tags
ansible-playbook playbooks/k3s_cluster.yml --tags "k3s"

# Run with specific inventory
ansible-playbook playbooks/proxmox.yml -i inventories/baremetal.yml
```

## Validation

### Pre-commit Hooks
The repository includes ansible-lint in pre-commit:
```bash
# Run from repo root
pre-commit run ansible-lint --all-files
```

### Manual Linting
```bash
cd ansible
ansible-lint playbooks/ roles/
```

### Syntax Check
```bash
ansible-playbook playbooks/k3s_cluster.yml --syntax-check
```

## Key Conventions

### K3s Node Labels
Node labels are defined via `k3s_node_labels` variable and use the `homelab.lan/` prefix:
- `homelab.lan/role` - Node role (general, storage, etc.)
- `homelab.lan/cpu-vendor` - CPU type (intel, amd)
- `homelab.lan/runtime` - Runtime type (vm, baremetal)
- `homelab.lan/gpu` - GPU presence (none, nvidia, intel)
- `topology.kubernetes.io/zone` - Proxmox node for zone awareness

### Variable Precedence
1. `host_vars/<host>.yml` - Highest precedence
2. `group_vars/<group>.yml`
3. Role `defaults/main.yml` - Lowest precedence

### Network Interface
The `k3s_iface` variable must be set for each host to specify the network interface for K3s communication.

### Intel GPU Perf Counters
K3s OS tuning configures perf sysctls on Intel GPU nodes (detected via `/sys/class/drm/renderD128/device/vendor`).
- `k3s_enable_gpu_perf_sysctl` (default: `true`)
- `k3s_perf_event_paranoid` (default: `0`)
- `k3s_kptr_restrict` (default: `0`)

## Common Tasks

| Task | Command |
|------|---------|
| Provision K3s cluster | `ansible-playbook playbooks/k3s_cluster.yml` |
| Configure Proxmox hosts | `ansible-playbook playbooks/proxmox.yml` |
| Check what would change | Add `--check` to any playbook command |
| Debug variable values | Add `-e "ansible_debug=true"` and use debug tasks |

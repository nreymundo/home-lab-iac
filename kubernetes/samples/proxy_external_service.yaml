# proxy_external_service_http.yaml
#
# Generic pattern for proxying an external HTTP (non-SSL) service through Traefik.
# This is the same Service+Endpoints+Ingress approach, but:
# - upstream is plain HTTP
# - no ServersTransport / no TLS-skip configuration
# - no "https-insecure" middleware/transport annotations
#
# Replace:
# - <APP_NAME>      (e.g. pihole, some-admin, legacy-app)
# - <UPSTREAM_IP>   (e.g. 192.168.10.50)
# - <UPSTREAM_PORT> (usually 80)
#
# Apply: kubectl apply -f proxy_external_service_http.yaml
# Clean: kubectl delete -f proxy_external_service_http.yaml

---
apiVersion: v1
kind: Namespace
metadata:
  name: external-proxy

---
apiVersion: v1
kind: Service
metadata:
  name: <APP_NAME>
  namespace: external-proxy
  annotations:
    # Tell Traefik to use HTTP when talking to the upstream
    traefik.ingress.kubernetes.io/service.serversscheme: http
spec:
  ports:
    - name: http
      port: 80
      targetPort: <UPSTREAM_PORT>

---
apiVersion: v1
kind: Endpoints
metadata:
  name: <APP_NAME>
  namespace: external-proxy
subsets:
  - addresses:
      - ip: <UPSTREAM_IP>
    ports:
      - name: http
        port: <UPSTREAM_PORT>
        protocol: TCP

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: <APP_NAME>
  namespace: external-proxy
  labels:
    external-dns: internal
  annotations:
    # If you want TLS at the edge (Traefik) even though the upstream is HTTP,
    # keep websecure + router.tls=true + spec.tls.
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"

    # LAN-only access
    traefik.ingress.kubernetes.io/router.middlewares: services-lan-allowlist@kubernetescrd
spec:
  ingressClassName: traefik
  rules:
    - host: <APP_NAME>.lan.${DOMAIN_NAME}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: <APP_NAME>
                port:
                  name: http
  tls:
    - hosts:
        - <APP_NAME>.lan.${DOMAIN_NAME}

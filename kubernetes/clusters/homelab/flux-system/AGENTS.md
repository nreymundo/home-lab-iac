# AGENTS.md

**Generated:** 2026-01-05 21:13:08
**Commit:** 9c644bd

## OVERVIEW

Flux GitOps configuration and Kustomization dependency chain.
**Key Pattern:** Dual-phase Kustomizations (`*-install` → `*-config`) for all components.

## WHERE TO LOOK

| Task | Location | Notes |
|------|----------|-------|
| **Add new component phase** | `*-install-kustomization.yaml`, `*-config-kustomization.yaml` | Dependency chain |
| **Helm repository sources** | `sources/` | Centralized HelmRepos |
| **Flux configuration** | `gotk-components.yaml`, `gotk-sync.yaml` | Flux installation (DO NOT EDIT) |
| **Flux health checks** | Kustomization `wait: true`, `timeout` fields | Automated verification |

## STRUCTURE

```
clusters/homelab/flux-system/
├── gotk-components.yaml          # Flux installation (GENERATED)
├── gotk-sync.yaml                # Git sync (GENERATED)
├── kustomization.yaml            # Root Kustomization
├── sources/
│   └── kustomization.yaml        # Bundles all HelmRepos
├── traefik-install-kustomization.yaml    # Traefik Helm
├── traefik-config-kustomization.yaml    # Traefik CRD
└── ... (one pair per component)
```

## CONVENTIONS

### Kustomization Dependency Chain
Each component has TWO Kustomizations:
- **`<name>-install-kustomization.yaml`**: Deploys HelmRelease + namespace
- **`<name>-config-kustomization.yaml`**: Deploys CRDs

**Critical:** `*-config` MUST have `dependsOn: <name>-install-kustomization`

### Helm Repository Management
- All `HelmRepository` resources centralized in `sources/`
- Source Kustomization applies all HelmRepos first

### Flux Configuration Files
- `gotk-components.yaml` & `gotk-sync.yaml` are **GENERATED by Flux**
- **NEVER** edit manually—run `flux install` to regenerate

### Health Checking
- Kustomizations use `wait: true` for critical components
- `timeout` fields define reconciliation limits

## ANTI-PATTERNS

1. **NEVER** edit `gotk-components.yaml` or `gotk-sync.yaml`—they're Flux-generated.
2. **DO NOT** break the `dependsOn` chain—config must depend on install.
3. **DO NOT** manually apply Kustomizations—let Flux reconcile.
4. **DO NOT** skip adding HelmRepo to `sources/` for new components.

## VERIFICATION

```bash
# Get all Kustomizations
flux get kustomizations --all-namespaces

# Check Kustomization status
flux get kustomization traefik-config -n flux-system

# Watch reconciliation
flux logs -f
```

## NOTES

- Kustomization naming convention: `<name>-install` and `<name>-config`.
- Install phases run before config phases (enforced by `dependsOn`).

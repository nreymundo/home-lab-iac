apiVersion: v1
kind: ConfigMap
metadata:
  name: authentik-blueprints-bootstrap
  namespace: authentik
data:
  # --- FILE 1: CORE BOOTSTRAP ---
  10-bootstrap.yaml: |
    version: 1
    metadata:
      name: homelab-bootstrap
      labels:
        blueprints.goauthentik.io/instantiate: "true"
    entries:
      - model: authentik_core.user
        state: present
        identifiers:
          username: !Env AK_BLUEPRINT_USER
        attrs:
          name: !Env AK_BLUEPRINT_USER
          email: !Env ACME_EMAIL
          is_active: true
          is_superuser: true
          password: !Env AK_BLUEPRINT_USER_PASSWORD

      - model: authentik_core.group
        identifiers:
          name: "authentik Admins"
        attrs:
          users:
            - !Find [authentik_core.user, [username, !Env AK_BLUEPRINT_USER]]

      - model: authentik_providers_proxy.proxyprovider
        id: proxy-provider
        identifiers:
          name: "Traefik-Gatekeeper"
        attrs:
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
          mode: forward_domain
          external_host: !Format ["https://sso.%s", !Env CLUSTER_DOMAIN]
          domain: !Env CLUSTER_DOMAIN
          cookie_domain: !Env CLUSTER_DOMAIN
          internal_host: ""
          internal_host_ssl_validation: true

      - model: authentik_core.application
        identifiers:
          slug: "gatekeeper"
        attrs:
          name: "Gatekeeper"
          provider: !KeyOf proxy-provider

      - model: authentik_outposts.outpost
        identifiers:
          name: "gatekeeper-proxy"
        attrs:
          type: "proxy"
          service_connection: !Find [authentik_outposts.kubernetesserviceconnection, [name, "Local Kubernetes Cluster"]]
          providers:
            - !KeyOf proxy-provider
          config:
            authentik_host: "http://authentik-server.authentik.svc.cluster.local"
            authentik_host_browser: !Format ["https://sso.%s", !Env CLUSTER_DOMAIN]
            log_level: debug

  # --- FILE 2: GRAFANA SSO (Corrected Syntax) ---
  20-grafana.yaml: |
    version: 1
    metadata:
      name: grafana-sso
      labels:
        blueprints.goauthentik.io/instantiate: "true"
    entries:
      - model: authentik_core.group
        identifiers:
          name: "Grafana Admins"

      - model: authentik_core.group
        identifiers:
          name: "Grafana Editors"

      - model: authentik_providers_oauth2.oauth2provider
        id: grafana-provider
        identifiers:
          name: "Grafana"
        attrs:
          client_id: !Env GRAFANA_CLIENT_ID
          client_secret: !Env GRAFANA_CLIENT_SECRET
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-explicit-consent]]
          redirect_uris:
            - url: !Format ["https://grafana.lan.%s/login/generic_oauth", !Env CLUSTER_DOMAIN]
              matching_mode: strict
          property_mappings:
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, openid]]
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, email]]
            - !Find [authentik_providers_oauth2.scopemapping, [scope_name, profile]]

      - model: authentik_core.application
        identifiers:
          slug: "grafana"
        attrs:
          name: "Grafana"
          provider: !KeyOf grafana-provider
          group: "Observability"

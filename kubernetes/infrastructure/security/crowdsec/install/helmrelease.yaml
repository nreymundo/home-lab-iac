apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: crowdsec
  namespace: crowdsec
spec:
  interval: 30m
  chart:
    spec:
      chart: crowdsec
      version: "0.21.*"
      sourceRef:
        kind: HelmRepository
        name: crowdsec
        namespace: flux-system
  values:
    container_runtime: containerd

    # --- LAPI Configuration ---
    lapi:
      replicas: 1
      env:
        - name: BOUNCER_KEY_TRAEFIK
          valueFrom:
            secretKeyRef:
              name: traefik-bouncer-key
              key: CROWDSEC_TRAEFIK_BOUNCER_API_KEY

      metrics:
        enabled: true
        serviceMonitor:
          enabled: true
          additionalLabels:
            release: observability-kube-prometheus-stack

      persistentVolume:
        data:
          enabled: true
          size: 1Gi
          storageClassName: longhorn-r2
        config:
          enabled: true
          size: 100Mi
          storageClassName: longhorn-r2

    # --- Agent Configuration ---
    agent:
      env:
        - name: COLLECTIONS
          value: "crowdsecurity/traefik crowdsecurity/base-http-scenarios firix/authentik"

      # What logs to read and which parser to use for which one.
      acquisition:
        - namespace: traefik
          podName: traefik-*
          program: traefik
        - namespace: authentik
          podName: authentik-*
          program: authentik

      metrics:
        enabled: true
        serviceMonitor:
          enabled: true
          additionalLabels:
            release: observability-kube-prometheus-stack

      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          memory: 256Mi

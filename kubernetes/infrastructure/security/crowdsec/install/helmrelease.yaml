apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: crowdsec
  namespace: crowdsec
spec:
  interval: 30m
  chart:
    spec:
      chart: crowdsec
      # renovate: datasource=helm depName=crowdsec registryUrl=https://crowdsecurity.github.io/helm-charts
      version: "0.22.*"
      sourceRef:
        kind: HelmRepository
        name: crowdsec
        namespace: flux-system
  valuesFrom:
    - kind: ConfigMap
      name: crowdsec-acquisition
  values:
    container_runtime: containerd

    # --- TLS Configuration ---
    # Enable TLS for LAPI-agent communication with cert-manager auto-generated CA.
    # Agents authenticate via TLS client certs, eliminating "user already exists" errors.
    tls:
      enabled: true
      certManager:
        enabled: true
      agent:
        tlsClientAuth: true

    lapi:
      replicas: 1
      env:
        - name: BOUNCER_KEY_TRAEFIK
          valueFrom:
            secretKeyRef:
              name: traefik-bouncer-key
              key: CROWDSEC_TRAEFIK_BOUNCER_API_KEY

      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi

      # Startup probe: gives LAPI time to initialize before liveness checks begin
      startupProbe:
        httpGet:
          path: /health
          port: lapi
        failureThreshold: 6
        periodSeconds: 5
        timeoutSeconds: 3

      # Liveness probe: continuously checks LAPI health and restarts pod if unhealthy
      livenessProbe:
        httpGet:
          path: /health
          port: lapi
        failureThreshold: 3
        periodSeconds: 10
        timeoutSeconds: 3

      readinessProbe:
        httpGet:
          path: /health
          port: lapi
        failureThreshold: 3
        periodSeconds: 10
        timeoutSeconds: 3

      metrics:
        enabled: true
        serviceMonitor:
          enabled: true
          additionalLabels:
            release: observability-kube-prometheus-stack

      persistentVolume:
        data:
          enabled: true
          size: 1Gi
          storageClassName: longhorn-r2
        config:
          enabled: true
          size: 100Mi
          storageClassName: longhorn-r2

    # --- Agent Configuration ---
    agent:
      env:
        - name: COLLECTIONS
          value: "crowdsecurity/traefik crowdsecurity/base-http-scenarios firix/authentik LePresidente/gitea"

      # Startup probe: gives agent time to initialize before liveness checks begin
      startupProbe:
        httpGet:
          path: /metrics
          port: metrics
        failureThreshold: 6
        periodSeconds: 5
        timeoutSeconds: 3

      # Liveness probe: continuously checks agent health and restarts pod if unhealthy
      livenessProbe:
        httpGet:
          path: /metrics
          port: metrics
        failureThreshold: 3
        periodSeconds: 10
        timeoutSeconds: 3

      metrics:
        enabled: true
        serviceMonitor:
          enabled: true
          additionalLabels:
            release: observability-kube-prometheus-stack

      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          memory: 256Mi

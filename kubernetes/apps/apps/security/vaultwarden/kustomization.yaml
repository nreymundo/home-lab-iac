apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
components:
  - ../../../../components/bjw-s-defaults
  - ../../../../components/common-env
  - ../../../../components/ingress/traefik-base
  - ../../../../components/storage/backup-policy
  - ../../../../components/db-backup

resources:
  - vaultwarden-db-secrets.sops.yaml
  - vaultwarden-secrets.sops.yaml
  - cnpg-cluster.yaml
  - helmrelease.yaml

patches:
  - target:
      kind: CronJob
      name: db-backup
    patch: |-
      apiVersion: batch/v1
      kind: CronJob
      metadata:
        name: vaultwarden-db-backup
        namespace: security
      spec:
        jobTemplate:
          spec:
            template:
              spec:
                containers:
                  - name: backup
                    env:
                      - name: APP_NAME
                        value: "vaultwarden"
                      - name: PGHOST
                        value: "vaultwarden-pg-rw.security.svc.cluster.local"
                      - name: PGUSER
                        valueFrom:
                          secretKeyRef:
                            name: "vaultwarden-db-secrets"
                      - name: PGPASSWORD
                        valueFrom:
                          secretKeyRef:
                            name: "vaultwarden-db-secrets"
                      - name: PGDATABASE
                        value: "vaultwarden"

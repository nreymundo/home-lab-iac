apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: vaultwarden
  namespace: security
spec:
  chart:
    spec:
      chart: app-template
  values:
    controllers:
      main:
        containers:
          main:
            image:
              # renovate: datasource=docker depName=vaultwarden/server
              repository: vaultwarden/server
              tag: 1.35.4
            env:
              TZ: Europe/Berlin
              DOMAIN: "https://vault.${CLUSTER_DOMAIN}"
              SIGNUPS_ALLOWED: "false"
              SIGNUPS_VERIFY: "true"
              REQUIRE_DEVICE_EMAIL: "true"
              INVITATIONS_ALLOWED: "false"
              SSO_ENABLED: "true"
              SSO_ONLY: "true"
              SSO_SIGNUPS_MATCH_EMAIL: "true"
              SSO_ALLOW_UNKNOWN_EMAIL_VERIFICATION: "false"
              SSO_AUTHORITY: "https://sso.${CLUSTER_DOMAIN}/application/o/vaultwarden/"
              SSO_SCOPES: "openid email profile offline_access"
              SSO_PKCE: "true"
              SSO_CLIENT_CACHE_EXPIRATION: "0"
              SSO_CLIENT_ID:
                valueFrom:
                  secretKeyRef:
                    name: vaultwarden-sso-secret
                    key: CLIENT_ID
              SSO_CLIENT_SECRET:
                valueFrom:
                  secretKeyRef:
                    name: vaultwarden-sso-secret
                    key: CLIENT_SECRET
              SHOW_PASSWORD_HINT: "false"
              DISABLE_ADMIN_TOKEN: "false"
              ORG_EVENTS_ENABLED: "true"
              ORG_GROUPS_ENABLED: "true"
              DATABASE_URL:
                valueFrom:
                  secretKeyRef:
                    name: vaultwarden-secrets
                    key: DATABASE_URL
              SMTP_HOST: mail.smtp2go.com
              SMTP_FROM: "vaultwarden@${CLUSTER_DOMAIN}"
              SMTP_FROM_NAME: Vaultwarden
              SMTP_PORT: "465"
              SMTP_SECURITY: force_tls
              SMTP_USERNAME:
                valueFrom:
                  secretKeyRef:
                    name: vaultwarden-secrets
                    key: SMTP_USERNAME
              SMTP_PASSWORD:
                valueFrom:
                  secretKeyRef:
                    name: vaultwarden-secrets
                    key: SMTP_PASSWORD
              SMTP_EMBED_IMAGES: "true"
              PUSH_ENABLED: "true"
              PUSH_INSTALLATION_ID:
                valueFrom:
                  secretKeyRef:
                    name: vaultwarden-secrets
                    key: PUSH_INSTALLATION_ID
              PUSH_INSTALLATION_KEY:
                valueFrom:
                  secretKeyRef:
                    name: vaultwarden-secrets
                    key: PUSH_INSTALLATION_KEY
              SENDS_ALLOWED: "true"
              EMERGENCY_ACCESS_ALLOWED: "true"
              USE_SYSLOG: ""
              LOG_LEVEL: warn
              ROCKET_CLI_COLORS: "false"
              EXTENDED_LOGGING: "true"
              IP_HEADER: X-Forwarded-For
              ADMIN_TOKEN:
                valueFrom:
                  secretKeyRef:
                    name: vaultwarden-secrets
                    key: ADMIN_TOKEN
            ports:
              - name: http
                containerPort: 80
              - name: ws
                containerPort: 3012
            resources:
              requests:
                cpu: 50m
                memory: 128Mi
              limits:
                cpu: 500m
                memory: 512Mi
    service:
      main:
        controller: main
        ports:
          http:
            port: 80
            targetPort: 80
          ws:
            port: 3012
            targetPort: 3012
    ingress:
      main:
        annotations:
          external-dns.alpha.kubernetes.io/hostname: vault.${CLUSTER_DOMAIN}
          gethomepage.dev/name: Vaultwarden
          gethomepage.dev/description: Password manager
          gethomepage.dev/group: "Security & Monitoring"
          gethomepage.dev/icon: vaultwarden.png
          gethomepage.dev/enabled: "true"
          gethomepage.dev/pod-selector: app.kubernetes.io/name=vaultwarden
        hosts:
          - host: vault.${CLUSTER_DOMAIN}
            paths:
              - path: /
                service:
                  identifier: main
                  port: http
              - path: /notifications/hub
                service:
                  identifier: main
                  port: ws
      admin:
        annotations:
          traefik.ingress.kubernetes.io/router.middlewares: traefik-gatekeeper-auth-chain@kubernetescrd
        hosts:
          - host: vault.${CLUSTER_DOMAIN}
            paths:
              - path: /admin
                pathType: Prefix
                service:
                  identifier: main
                  port: http
    persistence:
      data:
        enabled: true
        type: custom
        volumeSpec:
          persistentVolumeClaim:
            claimName: vaultwarden
        globalMounts:
          - path: /data

apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: frigate
  namespace: security
spec:
  chart:
    spec:
      chart: app-template
  values:
    defaultPodOptions:
      nodeSelector:
        homelab.lan/gpu: intel
      securityContext:
        fsGroup: 100
        supplementalGroups:
          - 44  # video group
          - 993  # render group
    controllers:
      main:
        initContainers:
          init-config:
            image:
              repository: docker.io/library/busybox
              tag: 1.37.0
            command:
              - sh
              - -c
              - |
                if [ ! -f /config/config.yml ]; then
                  echo "Config not found, copying default..."
                  cp /defaults/config.yml /config/config.yml
                else
                  echo "Config exists, skipping..."
                fi
        containers:
          main:
            image:
              # renovate: datasource=docker depName=blakeblackshear/frigate registryUrl=https://ghcr.io
              repository: ghcr.io/blakeblackshear/frigate
              tag: stable
            env:
              TZ: Europe/Berlin
              LIBVA_DRIVER_NAME: iHD
              FRIGATE_RTSP_PASSWORD:
                valueFrom:
                  secretKeyRef:
                    name: frigate-secrets
                    key: FRIGATE_RTSP_PASSWORD
              FRIGATE_CAMERA_USERNAME:
                valueFrom:
                  secretKeyRef:
                    name: frigate-secrets
                    key: FRIGATE_CAMERA_USERNAME
              FRIGATE_CAMERA_PASSWORD:
                valueFrom:
                  secretKeyRef:
                    name: frigate-secrets
                    key: FRIGATE_CAMERA_PASSWORD
              FRIGATE_MQTT_USER:
                valueFrom:
                  secretKeyRef:
                    name: frigate-secrets
                    key: FRIGATE_MQTT_USER
              FRIGATE_MQTT_PASSWORD:
                valueFrom:
                  secretKeyRef:
                    name: frigate-secrets
                    key: FRIGATE_MQTT_PASSWORD
            securityContext:
              privileged: true
            ports:
              - name: http
                containerPort: 8971
              - name: http-alternate
                containerPort: 5000
              - name: rtsp
                containerPort: 8554
              - name: webrtc-tcp
                containerPort: 8555
                protocol: TCP
              - name: webrtc-udp
                containerPort: 8555
                protocol: UDP
            resources:
              requests:
                cpu: 500m
                memory: 1Gi
              limits:
                cpu: 4
                memory: 4Gi
    service:
      main:
        controller: main
        annotations:
          traefik.ingress.kubernetes.io/service.serversscheme: https
          traefik.ingress.kubernetes.io/service.serverstransport: traefik-lan-https-insecure@kubernetescrd
        ports:
          http:
            port: 8971
      loadbalancer:
        controller: main
        type: LoadBalancer
        loadBalancerIP: ${FRIGATE_LB_IP}
        loadBalancerSourceRanges:
          - ${HOME_ASSISTANT_IP}/32
        ports:
          http:
            port: 8971
            targetPort: 8971
          http-alternate:
            port: 5000
            targetPort: 5000
          rtsp:
            port: 8554
            targetPort: 8554
          webrtc-tcp:
            port: 8555
            targetPort: 8555
            protocol: TCP
          webrtc-udp:
            port: 8555
            targetPort: 8555
            protocol: UDP
    ingress:
      main:
        annotations:
          external-dns.alpha.kubernetes.io/hostname: frigate.lan.${CLUSTER_DOMAIN}
          gethomepage.dev/name: Frigate
          gethomepage.dev/description: NVR with AI detection
          gethomepage.dev/group: Security & Monitoring
          gethomepage.dev/icon: frigate.png
          gethomepage.dev/enabled: "true"
          gethomepage.dev/widget.type: frigate
          gethomepage.dev/widget.url: "https://frigate-main.security.svc.cluster.local:8971"
          gethomepage.dev/widget.username: "homepage"
          gethomepage.dev/widget.password: '{{"{{HOMEPAGE_VAR_FRIGATE_PASSWORD}}"}}'
        hosts:
          - host: frigate.lan.${CLUSTER_DOMAIN}
            paths:
              - path: /
                service:
                  identifier: main
                  port: http
    persistence:
      data:
        enabled: true
        type: persistentVolumeClaim
        accessMode: ReadWriteOnce
        size: 5Gi
        storageClass: longhorn-r2
        globalMounts:
          - path: /config
      storage:
        type: nfs
        server: ${UNRAID_IP}
        path: /mnt/user/frigate_nvr
        globalMounts:
          - path: /media/frigate
      defaults:
        enabled: true
        type: secret
        name: frigate-config
        globalMounts:
          - path: /defaults
      cache:
        enabled: true
        type: emptyDir
        medium: Memory
        sizeLimit: 1Gi
        globalMounts:
          - path: /tmp/cache
      shm:
        enabled: true
        type: emptyDir
        medium: Memory
        sizeLimit: 1Gi
        globalMounts:
          - path: /dev/shm
      dri:
        enabled: true
        type: hostPath
        hostPath: /dev/dri
        globalMounts:
          - path: /dev/dri

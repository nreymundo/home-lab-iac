apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: frigate
  namespace: security
spec:
  chart:
    spec:
      chart: app-template
  values:
    defaultPodOptions:
      securityContext:
        fsGroup: 100
    controllers:
      main:
        replicas: 0
        initContainers:
          init-config:
            image:
              repository: docker.io/library/busybox
              tag: 1.37.0
            command:
              - sh
              - -c
              - |
                if [ ! -f /config/config.yml ]; then
                  echo "Config not found, copying default..."
                  cp /defaults/config.yml /config/config.yml
                else
                  echo "Config exists, skipping..."
                fi
        containers:
          main:
            image:
              # renovate: datasource=docker depName=blakeblackshear/frigate registryUrl=https://ghcr.io
              repository: ghcr.io/blakeblackshear/frigate
              tag: stable
            env:
              FRIGATE_RTSP_PASSWORD:
                valueFrom:
                  secretKeyRef:
                    name: frigate-secrets
                    key: FRIGATE_RTSP_PASSWORD
              FRIGATE_CAMERA_USERNAME:
                valueFrom:
                  secretKeyRef:
                    name: frigate-secrets
                    key: FRIGATE_CAMERA_USERNAME
              FRIGATE_CAMERA_PASSWORD:
                valueFrom:
                  secretKeyRef:
                    name: frigate-secrets
                    key: FRIGATE_CAMERA_PASSWORD
              FRIGATE_MQTT_USER:
                valueFrom:
                  secretKeyRef:
                    name: frigate-secrets
                    key: FRIGATE_MQTT_USER
              FRIGATE_MQTT_PASSWORD:
                valueFrom:
                  secretKeyRef:
                    name: frigate-secrets
                    key: FRIGATE_MQTT_PASSWORD
            ports:
              - name: http
                containerPort: 8971
              - name: rtsp
                containerPort: 8554
              - name: webrtc-tcp
                containerPort: 8555
                protocol: TCP
              - name: webrtc-udp
                containerPort: 8555
                protocol: UDP
            resources:
              requests:
                cpu: 500m
                memory: 1Gi
              limits:
                cpu: 4
                memory: 4Gi
    service:
      main:
        controller: main
        annotations:
          traefik.ingress.kubernetes.io/service.serversscheme: https
          traefik.ingress.kubernetes.io/service.serverstransport: traefik-lan-https-insecure@kubernetescrd
        ports:
          http:
            port: 8971
          rtsp:
            port: 8554
          webrtc-tcp:
            port: 8555
            protocol: TCP
          webrtc-udp:
            port: 8555
            protocol: UDP
    ingress:
      main:
        enabled: false
        annotations:
          external-dns.alpha.kubernetes.io/hostname: frigate.lan.${CLUSTER_DOMAIN}
          gethomepage.dev/name: Frigate
          gethomepage.dev/description: NVR with AI detection
          gethomepage.dev/group: Security & Monitoring
          gethomepage.dev/icon: frigate.png
          gethomepage.dev/enabled: "true"
        hosts:
          - host: frigate.lan.${CLUSTER_DOMAIN}
            paths:
              - path: /
                service:
                  identifier: main
                  port: http
    persistence:
      data:
        enabled: true
        type: persistentVolumeClaim
        accessMode: ReadWriteOnce
        size: 5Gi
        storageClass: longhorn-r2
        globalMounts:
          - path: /config
      # NFS storage mount injected by nfs-mount/frigate component
      defaults:
        enabled: true
        type: secret
        name: frigate-config
        globalMounts:
          - path: /defaults
      cache:
        enabled: true
        type: emptyDir
        medium: Memory
        sizeLimit: 1Gi
        globalMounts:
          - path: /tmp/cache
      shm:
        enabled: true
        type: emptyDir
        medium: Memory
        sizeLimit: 1Gi
        globalMounts:
          - path: /dev/shm

apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: paperless
  namespace: paperless
spec:
  chart:
    spec:
      chart: app-template
  values:
    controllers:
      # Paperless webserver
      main:
        pod:
          securityContext:
            runAsUser: 99
            runAsGroup: 100
            fsGroup: 100
            fsGroupChangePolicy: OnRootMismatch
        containers:
          main:
            image:
              # renovate: datasource=docker depName=paperless-ngx/paperless-ngx registryUrl=https://ghcr.io
              repository: ghcr.io/paperless-ngx/paperless-ngx
              tag: 2.20.9
            env:
              TZ: Europe/Berlin
              PAPERLESS_REDIS: redis://paperless-redis:6379
              PAPERLESS_DBHOST: paperless-pg-rw
              PAPERLESS_DBNAME: paperless
              PAPERLESS_DBUSER:
                valueFrom:
                  secretKeyRef:
                    name: paperless-db-secrets
                    key: username
              PAPERLESS_DBPASS:
                valueFrom:
                  secretKeyRef:
                    name: paperless-db-secrets
                    key: password
              PAPERLESS_TIKA_ENABLED: "1"
              PAPERLESS_TIKA_GOTENBERG_ENDPOINT: http://paperless-gotenberg:3000
              PAPERLESS_TIKA_ENDPOINT: http://paperless-tika:9998
              PAPERLESS_URL: "https://docs.lan.${CLUSTER_DOMAIN}"
              PAPERLESS_TIME_ZONE: Europe/Berlin
              PAPERLESS_OCR_LANGUAGE: deu+eng+spa
              PAPERLESS_OCR_LANGUAGES: deu eng spa
              PAPERLESS_OCR_USER_ARGS: '{"invalidate_digital_signatures": true}'
              PAPERLESS_SECRET_KEY:
                valueFrom:
                  secretKeyRef:
                    name: paperless-secrets
                    key: PAPERLESS_SECRET_KEY
              # OIDC / Authentik SSO
              PAPERLESS_APPS: allauth.socialaccount.providers.openid_connect
              PAPERLESS_SOCIALACCOUNT_PROVIDERS:
                valueFrom:
                  secretKeyRef:
                    name: paperless-oidc-secrets
                    key: PAPERLESS_SOCIALACCOUNT_PROVIDERS
              PAPERLESS_LOGOUT_REDIRECT_URL: "https://sso.lainternetdelpantano.xyz/application/o/paperless/end-session/"
              PAPERLESS_SOCIAL_AUTO_SIGNUP: "false"
              PAPERLESS_SOCIALACCOUNT_ALLOW_SIGNUPS: "true"
              PAPERLESS_DISABLE_REGULAR_LOGIN: "true"
              PAPERLESS_REDIRECT_LOGIN_TO_SSO: "true"
            ports:
              - name: http
                containerPort: 8000
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                cpu: 2000m
                memory: 2Gi

      # Redis broker
      redis:
        containers:
          redis:
            image:
              # renovate: datasource=docker depName=library/redis registryUrl=https://docker.io
              repository: docker.io/library/redis
              tag: "8"
            resources:
              requests:
                cpu: 25m
                memory: 64Mi
              limits:
                cpu: 250m
                memory: 256Mi

      # Gotenberg document converter
      gotenberg:
        containers:
          gotenberg:
            image:
              # renovate: datasource=docker depName=gotenberg/gotenberg registryUrl=https://docker.io
              repository: docker.io/gotenberg/gotenberg
              tag: "8.27"
            command:
              - gotenberg
              - --chromium-disable-javascript=true
              - --chromium-allow-list=file:///tmp/.*
            resources:
              requests:
                cpu: 50m
                memory: 128Mi
              limits:
                cpu: 1000m
                memory: 1Gi

      # Apache Tika
      tika:
        containers:
          tika:
            image:
              # renovate: datasource=docker depName=apache/tika registryUrl=https://docker.io
              repository: docker.io/apache/tika
              tag: latest
            resources:
              requests:
                cpu: 50m
                memory: 256Mi
              limits:
                cpu: 1000m
                memory: 1Gi

    service:
      main:
        controller: main
        ports:
          http:
            port: 8000
      redis:
        controller: redis
        ports:
          redis:
            port: 6379
      gotenberg:
        controller: gotenberg
        ports:
          http:
            port: 3000
      tika:
        controller: tika
        ports:
          http:
            port: 9998

    ingress:
      main:
        annotations:
          external-dns.alpha.kubernetes.io/hostname: docs.lan.${CLUSTER_DOMAIN}
          gethomepage.dev/enabled: "true"
          gethomepage.dev/name: Paperless
          gethomepage.dev/description: Document management
          gethomepage.dev/group: Utils
          gethomepage.dev/icon: paperless-ngx.png
        hosts:
          - host: docs.lan.${CLUSTER_DOMAIN}
            paths:
              - path: /
                service:
                  identifier: main
                  port: http

    persistence:
      data:
        enabled: true
        type: persistentVolumeClaim
        accessMode: ReadWriteOnce
        size: 5Gi
        storageClass: longhorn-r2
        advancedMounts:
          main:
            main:
              - path: /usr/src/paperless/data
      nfs-media:
        type: nfs
        server: ${UNRAID_IP}
        path: /mnt/user/paperless
        advancedMounts:
          main:
            main:
              - path: /usr/src/paperless/media
                subPath: media
      nfs-export:
        type: nfs
        server: ${UNRAID_IP}
        path: /mnt/user/paperless
        advancedMounts:
          main:
            main:
              - path: /usr/src/paperless/export
                subPath: export
      nfs-consume:
        type: nfs
        server: ${UNRAID_IP}
        path: /mnt/user/paperless
        advancedMounts:
          main:
            main:
              - path: /usr/src/paperless/consume
                subPath: consume
      nfs-backup:
        type: nfs
        server: ${UNRAID_IP}
        path: /mnt/user/backup
        advancedMounts:
          main:
            main:
              - path: /mnt/backup
      redis-data:
        enabled: true
        type: emptyDir
        advancedMounts:
          redis:
            redis:
              - path: /data

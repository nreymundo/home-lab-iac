# CLAUDE.md

This file provides guidance to AI coding assistants (Claude, Gemini, etc.) when working with code in this repository.

## Infrastructure Pipeline

This repository follows a strict dependency order - changes at one layer may affect downstream layers:

```
Packer → Terraform → Ansible → Kubernetes (Flux)
Build    Create      Configure   Deploy
templates VMs        K3s         apps
```

1. **Packer**: Builds VM templates on each Proxmox node for fast local cloning
2. **Terraform**: Creates K3s node VMs from templates, generates Ansible inventory
3. **Ansible**: Configures VMs and bootstraps K3s cluster
4. **Kubernetes**: Flux GitOps continuously reconciles cluster state from Git

## Common Commands

### Pre-commit Hooks (Run Before Committing)
```bash
pre-commit install                    # Install hooks (run once)
pre-commit run --all-files           # Run all hooks
pre-commit run ansible-lint --all-files
pre-commit run terraform-fmt --all-files
pre-commit run packer-fmt --all-files
pre-commit run yamllint --all-files
```

### Packer (VM Templates)
```bash
cd packer/ubuntu-24.04-base
./build.sh                           # Build template (injects SSH keys from Bitwarden)
packer validate .                    # Validate configuration
packer fmt .                         # Format HCL files
```

**Always use `./build.sh`** instead of `packer build` - it handles Bitwarden SSH key injection and generates cloud-init configs.

### Terraform (Provision K3s Nodes)
```bash
cd terraform/k3s_nodes
terraform init                       # Initialize providers
terraform plan                       # Preview changes
terraform apply                      # Apply changes
terraform fmt                        # Format HCL files
terraform validate                   # Validate configuration
```

**Configuration file**: `terraform/k3s_nodes/terraform.tfvars` - modify `nodes` list to add/remove K3s nodes.

### Ansible (Configure VMs & Deploy K3s)
```bash
cd ansible
ansible-playbook playbooks/k3s_cluster.yml --check   # Dry run
ansible-playbook playbooks/k3s_cluster.yml           # Full run
ansible-lint playbooks/ roles/                       # Lint playbooks/roles
```

**Auto-generated inventory**: `ansible/inventories/k3s-nodes.yml` is regenerated by Terraform. Do not edit manually.

### Kubernetes/Flux (GitOps)
```bash
flux get all -A                                        # Check all resources
flux get helmreleases -A                               # List HelmReleases
flux reconcile kustomization flux-system --with-source  # Force sync
kubectl get events -A --sort-by='.lastTimestamp' | tail -20  # Recent events
```

## Architecture

### Network
- VLAN 10 for K3s nodes (192.168.10.0/24, gateway 192.168.10.1)
- Node IPs start at 192.168.10.50
- MetalLB pool: 192.168.10.200-192.168.10.250

### K3s Node Labels
All nodes receive these labels (override via Terraform):
- `homelab.lan/role` - Node purpose (general, storage)
- `homelab.lan/cpu-vendor` - CPU type (intel, amd)
- `homelab.lan/runtime` - vm or baremetal
- `homelab.lan/gpu` - GPU type or none (legacy; prefer NFD GPU labels for scheduling)
- `topology.kubernetes.io/zone` - Proxmox node name for zone awareness

### Storage Classes
- `longhorn-r2` - Longhorn with 2 replicas (default for critical apps)
- `longhorn-r1` - Longhorn with 1 replica (ephemeral data)
- NFS PVCs (`nfs-media`, `nfs-downloads`) - Large media files

### Kubernetes Directory Structure
```
kubernetes/
├── clusters/production/ks/           # Kustomizations numbered for ordering (00-99)
│   ├── 00-infrastructure.yaml       # Sources, config
│   ├── 10-metallb-install.yaml      # Networking
│   ├── ...                          # 20-29: DNS, 30-39: replication, 40-49: security
│   └── 90-apps.yaml                 # Application deployments
├── infrastructure/                   # Cluster components (networking, storage, etc.)
├── apps/apps/                       # Application HelmReleases
└── components/                       # Reusable Kustomize components
```

**Never edit** `kubernetes/clusters/production/flux-system/` - these are Flux bootstrap files.

> **⚠️ Important for AI Agents:**
> 1. **NEVER commit changes unless explicitly asked by the user.** Even if all changes are ready and pre-commit passes, wait for the user to request a commit.
> 2. **Never run `flux reconcile` commands unless explicitly asked by the user.** Flux automatically reconciles on Git push. Manual reconciliation can interfere with in-progress deployments and cause unexpected behavior.

### Kustomize Components
Reusable components in `kubernetes/components/` reduce duplication:

| Component | Path | Purpose |
|-----------|------|---------|
| bjw-s-defaults | `components/bjw-s-defaults` | Adds `interval`, `version`, `sourceRef` for bjw-s app-template |
| traefik-base | `components/ingress/traefik-base` | Sets `enabled: true`, `className: traefik` for `ingress.main` |
| auth-guard | `components/ingress/auth-guard` | Injects Authentik middleware for `ingress.main` |
| backup-policy | `components/storage/backup-policy` | Longhorn daily/weekly backup labels for `persistence.data` and CNPG clusters |
| arr-custom-scripts | `components/arr-custom-scripts` | Custom scripts volume for *arr applications |

## Secrets Management

Secrets are managed through **Bitwarden Secrets Manager** (infrastructure) and **SOPS** (Kubernetes):

| Component | Method |
|-----------|--------|
| Packer | `bws` CLI for SSH public keys during VM build |
| Terraform | `bitwarden-secrets` provider for SSH keys |
| Kubernetes | SOPS (AGE-encrypted `*.sops.yaml` files in Git) |

Kubernetes secrets are cross-namespace replicated via `kube-replicator`.

## Common Patterns

### Adding a New K3s Node
1. Edit `terraform/k3s_nodes/terraform.tfvars`: add entry to `nodes` list
2. Run `terraform apply`
3. Run `ansible-playbook playbooks/k3s_cluster.yml`

### Adding a New Kubernetes App
1. Create `kubernetes/apps/apps/<category>/<app-name>/`
2. Create `helmrelease.yaml` and `kustomization.yaml`.
3. In `kustomization.yaml`, include standard components (`bjw-s-defaults`, `ingress/traefik-base`).
4. In `helmrelease.yaml`, use standard `main` keys for controllers, containers, and ingress to ensure component compatibility.
5. Add to parent kustomization in `<category>/kustomization.yaml`
6. Commit and push - Flux auto-reconciles

### GPU Workloads (Intel iGPU)
- GPU discovery and scheduling are handled by NFD + Intel GPU device plugin.
- Request a GPU share with `resources.limits.gpu.intel.com/i915: 1` (and match `requests`).
- Do not mount `/dev/dri` via hostPath or run `privileged: true` for GPU access.
- For OpenVINO workloads, add capabilities as needed: `IPC_LOCK`, `SYS_RAWIO`, `PERFMON`.
- `sharedDevNum: 10` is per GPU device; each GPU advertises 10 allocatable shares.

### Ingress Conventions
- Ingress class: `traefik` (handled by `ingress/traefik-base` component)
- Key: `ingress.main` (standardized across apps)
- Domain pattern: `<app>.lan.${CLUSTER_DOMAIN}` for internal apps
- Auth middleware: `traefik-gatekeeper-auth-chain@kubernetescrd` (injected by `ingress/auth-guard`)
- DNS annotation: `external-dns.alpha.kubernetes.io/hostname: <fqdn>` (must be set in `helmrelease.yaml`)

### Homepage Integration
Add `gethomepage.dev/*` annotations to ingress for Homepage dashboard discovery:
```yaml
gethomepage.dev/enabled: "true"
gethomepage.dev/name: <App Name>
gethomepage.dev/description: <Short description>
gethomepage.dev/group: <Category>           # Media, Security & Monitoring, Networking, Storage
gethomepage.dev/icon: <app>.png             # From dashboard-icons
# Optional: For widget integration
gethomepage.dev/widget.type: "<app-type>"
gethomepage.dev/widget.url: "http://<service>.<namespace>.svc.cluster.local:<port>"
gethomepage.dev/widget.key: '{{"{{HOMEPAGE_VAR_<APP>_KEY}}"}}'
```

### HelmRelease with bjw-s app-template (Standard Pattern)
```yaml
spec:
  values:
    controllers:
      main:
        containers:
          main:
            image:
              repository: ...
    service:
      main:
        controller: main
    ingress:
      main:
        hosts:
          - host: app.lan.${CLUSTER_DOMAIN}
            paths:
              - path: /
                service:
                  identifier: main
```

## Component-Specific Instructions

Detailed guidance for each component is maintained in:
- `packer/CLAUDE.md` - VM template building
- `terraform/CLAUDE.md` - K3s node provisioning
- `ansible/CLAUDE.md` - VM configuration and K3s deployment
- `kubernetes/CLAUDE.md` - Flux GitOps and application deployment
- `kubernetes/infrastructure/security/authentik/CLAUDE.md` - SSO blueprints and outpost management

## Documentation Maintenance

When making material changes to this repository, update the relevant documentation:

| Change Type | Files to Update |
|-------------|-----------------|
| New/modified Terraform variables or workflow | `terraform/CLAUDE.md` |
| New Packer template or build process changes | `packer/CLAUDE.md` |
| New Ansible role or playbook changes | `ansible/CLAUDE.md` |
| New Kubernetes component, pattern, or convention | `kubernetes/CLAUDE.md` |
| New Authentik blueprint or SSO configuration | `kubernetes/infrastructure/security/authentik/CLAUDE.md` |
| Cross-cutting changes (workflow, conventions, commands) | Root `CLAUDE.md` |

Keep documentation synchronized with code changes to ensure AI assistants have accurate context.

## Renovate Configuration

Renovate automatically updates:
- Flux HelmReleases (minor/patch versions auto-merge on Sundays)
- Docker images
- Terraform provider versions
- Kubernetes manifests

Configured to group observability and networking updates. Major versions and 0.x.x apps require manual review.

## Key Conventions

- VM IDs: Start at 200 for nodes, 9000+ for templates
- Commit messages: Conventional Commits format (`feat(scope): description`)
- Variables: Use `${CLUSTER_DOMAIN}` for domain substitution in Kubernetes manifests
- File naming: `k3s-node-01`, `k3s-node-02`, etc. for sequential nodes

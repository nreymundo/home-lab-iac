# AGENTS.md

**Instructions for AI Coding Assistants (Cursor, Copilot, etc.)**

If you are an AI agent reading this, these rules are **LAW**.

**Generated:** 2026-01-05 21:13:08
**Commit:** 9c644bd
**Branch:** master

## OVERVIEW

Home Lab Infrastructure as Code implementing GitOps workflow.
**Stack:** Proxmox VE + K3s + Ansible + Terraform + Packer + Flux.
**Pipeline:** Packer → Terraform → Ansible → Flux.

## STRUCTURE

```
home-lab-iac/
├── ansible/                    # Host configuration (roles, playbooks, inventories)
│   ├── roles/                  # Reusable Ansible roles
│   ├── playbooks/              # Entry point playbooks
│   └── inventories/            # Static and generated inventories
├── packer/                     # VM template building (Ubuntu, Fedora)
│   ├── scripts/                # Shared build scripts
│   └── */build.sh              # Template-specific builds
├── terraform/                  # Infrastructure provisioning
│   └── k3s_nodes/              # K3s VM provisioning + Ansible inventory gen
├── kubernetes/                 # Flux GitOps definitions
│   ├── clusters/homelab/       # The actual cluster state
│   │   ├── flux-system/        # Flux config & Kustomization chain
│   │   ├── infrastructure/     # Core apps (Traefik, Storage, Auth)
│   │   └── apps/               # User applications
│   └── samples/                # Helm release templates
└── docs/                       # Human documentation
```

## WHERE TO LOOK

| Task | Location | Notes |
|------|----------|-------|
| **Provision new VMs** | `terraform/k3s_nodes/` | Run `terraform apply` first |
| **Configure hosts** | `ansible/playbooks/` | After Terraform updates inventory |
| **Deploy Kubernetes app** | `kubernetes/clusters/homelab/infrastructure/` | Use install/config split |
| **Build VM template** | `packer/*/build.sh` | Secret-injected via Bitwarden |
| **Troubleshoot Flux** | `kubernetes/clusters/homelab/flux-system/` | Check Kustomization dependencies |
| **Add new host** | `terraform/k3s_nodes/vars.tf` | Update VM ID scheme |
| **Add monitoring** | Component `config/` dirs | Add PodMonitor/ServiceMonitor |

## CONVENTIONS (Deviations from standard)

### Ansible
- **Dynamic Inventory**: `k3s-nodes.yml` is GENERATED by Terraform—NEVER edit manually
- **Check Mode**: Roles use `when: not ansible_check_mode` for destructive tasks
- **Common Role**: Abstracts OS differences (Debian/Fedora) automatically

### Terraform
- **Local State**: Uses `terraform.tfstate` (local, not remote)
- **Inventory Bridge**: Renders Ansible inventory via `local_file` resource
- **Bitwarden Integration**: Fetches secrets for cloud-init templates

### Packer
- **Secret Injection**: Uses `fetch-ssh-keys.sh` (Bitwarden CLI) at build time
- **VM ID Scheme**: Ubuntu 9000-9019, Fedora 9020-9039 (see packer/README.md)
- **Template Engine**: `generate-autoinstall.sh` handles cloud-init + kickstart

### Flux / Kubernetes
- **Install vs Config**: Components split into `/install` (Helm) and `/config` (CRDs)
- **Kustomization Chain**: `*-config` always `dependsOn: *-install`
- **Never kubectl apply**: Flux owns cluster state—push to git instead
- **Secrets**: Use Bitwarden Secrets Manager with Flux `substituteFrom`

## ANTI-PATTERNS (This Project)

1. **NEVER** commit secrets (API keys, passwords, private keys). Use Bitwarden IDs or placeholders.
2. **NEVER** modify `ansible/inventories/k3s-nodes.yml` manually (Terraform owns it).
3. **NEVER** use `kubectl apply` for resources in `kubernetes/` directory (Flux owns it).
4. **NEVER** delete `terraform.tfstate`.
5. **NEVER** edit Flux-generated files (`gotk-components.yaml`, `gotk-sync.yaml`).
6. **DO NOT** use port forwarding (80/443)—all external access via VPN (Wireguard).
7. **DO NOT** make static Ansible inventory executable (`chmod 644`).

## UNIQUE STYLES

### Documentation Law
**When making changes, YOU MUST update the relevant documentation.**
- New component → Create/Update `README.md` in that folder
- Architecture change → Update `docs/ARCHITECTURE.md`
- Network/IP change → Update `docs/NETWORKING.md`
- Security pattern → Update `docs/SECURITY.md`

### Kernel Parameter Safety
Ansible roles (`common`, `proxmox`) implement merging with safety guards to prevent modifying boot-critical parameters (`root=`, `init=`, `resume=`).

### Naming Conventions
- **K8s Resources**: Kebab-case (`my-app-name`)
- **Mixed**: Repository uses both `k3s-nodes` (kebab) and `k3s_nodes` (snake)
- **Flux Kustomizations**: `<name>-install` and `<name>-config` pattern

## COMMANDS

```bash
# Ansible
ansible-playbook -i inventories/baremetal.yml playbooks/rpi.yml --syntax-check
ansible-lint playbooks/*.yml

# Terraform
terraform fmt -check
terraform validate

# Packer
packer validate .

# Kubernetes
kubectl apply -f <file> --dry-run=client
flux logs -f

# Verification
pre-commit run --all-files
```

## NOTES

- **Pre-commit is mandatory**: Install with `pre-commit install`—it runs before every commit.
- **Sequential Pipeline**: Must run in order: Packer → Terraform → Ansible → Git push (Flux).
- **SSH Keys**: Retrieved from Bitwarden Secrets Manager—ensure `BW_SSH_KEYS_ID` is exported.
- **Check Mode**: Always test Ansible with `--check` (dry run) before applying.
- **Flux Dependencies**: If a HelmRelease fails, check that the `*-install` Kustomization completed first.
